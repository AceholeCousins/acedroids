<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="icon" href="media/images/adfav.ico" type="image/vnd.microsoft.icon">
		<title>AceDroids</title>
		<style>
			body {
				margin: 0px;
				background-color: #000000;
				overflow: hidden;
			}
			td {
				text-align: center;
			}
		</style>
	</head>
	<body>
		<table id ="splashscreen" style="position:absolute;
			top:20%; left:20%; width:60%; height:60%; zIndex:1000;">
		<tr><td style="color:black; background-color:white; font-size:30pt;
			vertical-align:middle; text-align:center; padding:5%;
			border-radius:15px 50px; background: url(media/images/quotebg.jpg);
			-webkit-background-size: cover;	-moz-background-size: cover;
			-o-background-size: cover; background-size: cover;">
		<span id="splashscreentext"></span>
		</td></tr></table>	

		<script src="config.js"></script> <!-- configuration file -->		
		<script src="src/quotes.js"></script> <!-- quotes to nicen loading time -->

		<script type="text/javascript">

			var CFGVERSION = 1; // version of the config string pattern

			document.getElementById("splashscreentext").innerHTML = "<b>" + QUOTES[Math.floor(Math.random()*QUOTES.length)]
				+ "</b><br><br><i>loading...</i>";

			var PARAMS = location.hash;
			if(PARAMS == ""){
				PARAMS = "#adcfgv:" + CFGVERSION
					+ "debug:0;player:Dani,keyboard,pink;player:Mirko,mouse,lime;"
					+ "player:Oli,gamepad1,red;player:Sebbi,gamepad2,yellow";
			}
			PARAMS = PARAMS.slice(1).split(';');
			if(PARAMS[0] != 'adcfgv:' + CFGVERSION){
				alert("Link contains invalid or outdated game configuration!");
				PARAMS = "#adcfgv:" + CFGVERSION
					+ "debug:0;player:Dani,keyboard,pink;player:Mirko,mouse,lime;"
					+ "player:Oli,gamepad1,red;player:Sebbi,gamepad2,yellow";
			}

			var NUM_PLAYERS = 0;
			
			for(var i=0; i<PARAMS.length; i++){
				var key = PARAMS[i].split(':')[0];
				var value = PARAMS[i].split(':')[1];

				// the ..0 items are for single player mode
				if(key == "game" || key == "game0"){GAME_MODE = value;}
				if(key == "player" || key == "player0"){NUM_PLAYERS++;} // players are read later
				if(key == "hp"){HITPOINTS = value * 1;}
				if(key == "shld"){SHIELD = value *1;}
				if(key == "shldreg"){SHIELD_REGEN = value * 1;}
				if(key == "ammo"){PHASER_AMMO = value * 1;}
				if(key == "ammoreg"){PHASER_REGEN = value * 1;}
				if(key == "time"){ROUND_TIME = value * 1;}
				if(key == "map" || key == "map0"){MAP = value;}
				if(key == "bump" || key == "bump0"){TERRAIN_BUMP_MAPPING = value=="1";}
				if(key == "h2o" || key == "h2o0"){FANCY_WATER = value=="1";}
				if(key == "vol" || key == "vol0"){MUSIC_VOLUME = 0.01*value;}
				if(key == "debug" || key == "debug0"){DEBUG = 1*value;}
			}
		</script>

		<script src="src/jslibs/three.js"></script> <!-- WebGL wrapper, main framework (http://threejs.org) -->
		<!--<script src="src/jslibs/math.min.js"></script>--> <!-- math functions (http://mathjs.org/) (SEEMS BUGGY)-->
		<script src="src/jslibs/OrbitControls.js"></script> <!-- camera orbit controls, part of three.js -->
		<script src="src/jslibs/p2.js"></script> <!-- p2 physics engine (https://schteppe.github.io/p2.js) -->
		<script src="src/jslibs/stats.min.js"></script> <!-- framerate display -->
		<script src="src/jslibs/DDSLoader.js"></script> <!-- file loader, part of three.js -->
		<script src="src/jslibs/OBJLoader.js"></script> <!-- file loader, part of three.js -->
		<script src="src/jslibs/MTLLoader.js"></script> <!-- file loader, part of three.js -->
		<script src="src/jslibs/distancetf.js"></script> <!-- distance transform for boolean images (extracted from https://parmanoir.com/distance) -->
		<script src="src/jslibs/buffer-loader.js"></script> <!-- loader that was used by the sound tutorial page http://www.html5rocks.com/en/tutorials/webaudio/intro/ -->
		<script src="src/jslibs/GPUComputationRenderer.js"></script> <!-- for water cellular automata https://github.com/mrdoob/three.js/blob/dev/examples/js/GPUComputationRenderer.js -->
		<script src="src/jslibs/THREE.MeshLine.js"></script> <!-- for trails https://github.com/spite/THREE.MeshLine -->

		<script src="src/imglib.js"></script>
		<script src="src/Checklist.js"></script>
		<script src="src/mechanics.js"></script>
		<script src="src/scene.js"></script>
		<script src="src/Trail.js"></script>
		
                <script src="src/control/Control.js"></script>
                <script src="src/control/Mouse.js"></script>
                <script src="src/control/Gamepad.js"></script>
                <script src="src/control/Keyboard.js"></script>                
                <script src="src/control/MobileDevice.js"></script>
		
        <script src="src/Sound.js"></script>
		<script src="src/HBObject.js"></script>
		<script src="src/Effect.js"></script>
		<script src="src/explosion.js"></script>
		<script src="src/Flame.js"></script>
		<script src="src/Hovercraft.js"></script>
		<script src="src/Phaser.js"></script>

			<script src="src/arena/ArenaSvgLoader.js"></script>
			<script src="src/arena/Arena.js"></script>

		<script src="src/Water.js"></script>
		<script src="src/camera.js"></script>
		<script src="src/powerups.js"></script>
		<script src="src/scoretable.js"></script>
		<script src="medals.js"></script>


		<script type="text/javascript">

			var GAME_PHASE; // S for pre start, G for... going... on, O for over, R for results, P for paused

			var hovers=[];
			var ARENA = new Arena(MAP);
			var SCORETABLE = new ScoreTable();
			var SCORETABLE_PROTECT = false;
			GRAPHICS_SCENE.add(SCORETABLE.plane);
			SCORETABLE.plane.visible = false;
			
			var STARTLINE, FINISHLINE;

			function start() {
				onWindowResize(); // call to initially adjust camera
				document.getElementById("splashscreen").style.visibility = "hidden";
				RENDERER.setClearColor( FOG_COLOR );
				
				if(GAME_MODE == "T" || GAME_MODE == "R"){ // race or time trial
					STARTLINE = ASL.getline("startline");
					FINISHLINE = ASL.getline("finishline");
				}

				var iPlayer=0;

				for(var i=0; i<PARAMS.length; i++){
					var key = PARAMS[i].split(':')[0];
					var value = PARAMS[i].split(':')[1];

					if(key=="player" || key=="player0"){
						hovers[iPlayer] = new Hovercraft(
								new THREE.Color(value.split(',')[1]),
								Control.createControl(value));
						hovers[iPlayer].playerName = value.split(',')[0];
						iPlayer++;
					}
				}

				if(GAME_MODE == "T" || GAME_MODE == "R"){
					SCORETABLE.prepare(NUM_PLAYERS+4, [1,1], [0.4,0.2,0.4], ["c", "c"]); // room for medal
				}
				else if(GAME_MODE == "D"){
					SCORETABLE.prepare(NUM_PLAYERS+2, [1,0.3,0.3,0.3], [0.2,0.1,0.1,0.1,0.2], ["c", "c", "c", "c"]);
				}
				
				newRound();
				gameloop();
			}
			LOADING_LIST.setCallback(start);

			function gameloop() {

				requestAnimationFrame( gameloop );

				if(GAME_PHASE != "P"){ // not paused
					updateIngameTimeouts(); // ingame timeouts also run during start and over phase (for triggering their end)

					if(GAME_MODE == "D"){maybeSpawnPowerup();}

					PHYSICS_WORLD.step(DT);

					if((GAME_MODE == "T" || GAME_MODE == "R") && GAME_PHASE == "G"){ // time trial or race, ongoing

						var allFinished = true;

						for(var i=0; i<hovers.length; i++){

							if(!hovers[i].finished){
								hovers[i].racetime += DT;
								allFinished = false;
							}

							var finish = linesegintersect(hovers[i].lastPosition, hovers[i].newPosition, FINISHLINE.p0, FINISHLINE.p1);

							if(finish.bool){ // crossed the finish line
								hovers[i].finished = true;
								hovers[i].hitpoints = 0; // explode
								hovers[i].racetime += -DT + finish.s*DT; // subframe accuracy for time measurement!
							}
						}
						if(allFinished){
							GAME_PHASE = "O"; // game is over
							ingameTimeout(1, function(){endRound();});
						}
					}

					if(GAME_PHASE == "R"){
						var continus = 0;
						for(var i=0; i<hovers.length; i++){
							hovers[i].control.update();
							if(hovers[i].control.fire){hovers[i].continu = true;}
							if(hovers[i].continu){continus++;}
						}
						if(continus > NUM_PLAYERS/2 && !SCORETABLE_PROTECT){newRound();} // majority vote
					}

					updateAllHBObjects();

					updateCam();
					INGAME_TIME += DT;

					updateAllEffects();
					updateWater();

				}

				RENDERER.render( GRAPHICS_SCENE, CAMERA );
				if(DEBUG>=1){STATS.update()};

				FRAME_COUNTER++;
				
				// explosion testing
				/*if(FRAME_COUNTER% 6  == 5){
					explosion(new THREE.Vector3(Math.random()*40-20, Math.random()*30-15, 0), new THREE.Color(Math.floor(Math.random()*0x1000000)));
				}*/
				
			}

			function endRound(){ // display results

				GAME_PHASE = "R";
				SCORETABLE_PROTECT = true;
				ingameTimeout(2, function(){SCORETABLE_PROTECT = false;}); // show scoretable for at least 2 seconds
				
				if(GAME_MODE == "T" || GAME_MODE == "R"){ // race or time trial
					hovers.sort(function(a, b){return (a.racetime - b.racetime);});
					// not sure if it is a good idea to shuffle this array, lets see
					SCORETABLE.clear();
					SCORETABLE.line(["P L A Y E R", "T I M E"], new THREE.Color("black"));
					SCORETABLE.line(["", ""], new THREE.Color("black"));

					var highscore = 1e6;

					for(var i=0; i<hovers.length; i++){
						SCORETABLE.line([hovers[i].playerName, 
								Math.floor(hovers[i].racetime/60) + ":"
								+ pad(Math.floor(hovers[i].racetime%60),2) + "."
								+ pad(Math.round(1000*(hovers[i].racetime%1)),3)],
								hovers[i].color);

						highscore = getCookie(MAP);
						if(highscore == ""){highscore = 1e6;}
						highscore *= 1; // string to numba
						if(hovers[i].racetime < highscore){
							setCookie(MAP, hovers[i].racetime + "", 3650); // numba 2 string
							SCORETABLE.line(["", "Highscore!"], hovers[i].color);
							var award = medal(MAP, hovers[i].racetime);
							if(award == "bronze"){SCORETABLE.line(["", "Bronze."], new THREE.Color("firebrick"));}
							if(award == "silver"){SCORETABLE.line(["", "Silver!"], new THREE.Color("silver"));}
							if(award == "gold"){SCORETABLE.line(["", "Gold!!!"], new THREE.Color("gold"));}
							if(award == "bronze"){SCORETABLE.line(["", "DIAMOND!!!1"], new THREE.Color("azure"));}
							highscore = hovers[i].racetime;
						}
		
					}
					
					SCORETABLE.line(["Highscore", 
							Math.floor(highscore/60) + ":"
							+ pad(Math.floor(highscore%60),2) + "."
							+ pad(Math.round(1000*(highscore%1)),3)],
							new THREE.Color("black"));

					SCORETABLE.plane.visible = true;

				}

				else if(GAME_MODE == "D"){ // death match
					hovers.sort(function(a, b){return (b.kills*1.1-b.deaths) - (a.kills*1.1-a.deaths);});
					// not sure if it is a good idea to shuffle this array, lets see
					SCORETABLE.clear();
					SCORETABLE.line(["P L A Y E R", "SCORE ", "KILLS ", "DEATHS"], new THREE.Color("black"));
					SCORETABLE.line(["", "", "", ""], new THREE.Color("black"));

					for(var i=0; i<hovers.length; i++){
						SCORETABLE.line([hovers[i].playerName, 
								hovers[i].kills*1.1 - hovers[i].deaths,
								hovers[i].kills,
								hovers[i].deaths],
								hovers[i].color);			
					}
					SCORETABLE.plane.visible = true;
				}
			}

			function newRound(){
				GAME_PHASE = "S";

				INGAME_TIME = 0;

				SCORETABLE.plane.visible = false;				

				for(var i=0; i<hovers.length; i++){
					hovers[i].initNewRound(i);
				}

				for(var i=0; i<EFFECT_LIST.length; i++){
					EFFECT_LIST[i].despawn();
				}
				updateAllEffects();

				for(var i=0; i<HBO_LIST.length; i++){
					if(HBO_LIST[i].type != 'hover'){
						HBO_LIST[i].despawn();
					}
				}
				NPUBOXES = 0;
				GLOBAL_POWERUP_TARGET.pu = POWERUPS.nothing;
				GLOBAL_POWERUP_TARGET.victim = [];
				DT = DT_ORIGINAL;

				updateAllHBObjects();				

				TIMEOUT_LIST = [];

				ingameTimeout(1, function(){GAME_PHASE = "G";});

				if(GAME_MODE == "D"){ // death match
					ingameTimeout(ROUND_TIME+1, function(){
						endRound();
					}); // time limit
				}
			}

		</script>
	</body>
</html>
