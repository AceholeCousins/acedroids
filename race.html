<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<link rel="icon" href="media/images/adfav.ico" type="image/vnd.microsoft.icon">
		<title>AceDroids</title>
		<style>
			body {
				margin: 0px;
				background-color: #000000;
				overflow: hidden;
			}
			td {
				text-align: center;
			}
		</style>
	</head>
	<body>
		<table id ="splashscreen" style="position:absolute;
			top:20%; left:20%; width:60%; height:60%; zIndex:1000;">
		<tr><td style="color:black; background-color:white; font-size:30pt;
			vertical-align:middle; text-align:center; padding:5%;
			border-radius:15px 50px; background: url(media/images/quotebg.jpg);
			-webkit-background-size: cover;	-moz-background-size: cover;
			-o-background-size: cover; background-size: cover;">
		<span id="splashscreentext"></span>
		</td></tr></table>	

		<div id="arenadrawing" style="height:0; width:0"></div> <!-- graphics container for the SVG library -->
		<canvas id="canvasbuffer" width=100 height=100 style="display:none"></canvas> <!-- buffer canvas for pixel access in images -->

		<script src="config.js"></script> <!-- configuration file -->		
		<script src="src/quotes.js"></script> <!-- quotes to nicen loading time -->

		<script type="text/javascript">

			var CFGVERSION = 1; // version of the config string pattern

			document.getElementById("splashscreentext").innerHTML = "<b>" + QUOTES[Math.floor(Math.random()*QUOTES.length)]
				+ "</b><br><br><i>loading...</i>";

			var PARAMS = location.hash;
			if(PARAMS == ""){
				PARAMS = "#adcfgv:" + CFGVERSION
					+ "debug:0;player:Dani,keyboard,pink;player:Mirko,mouse,lime;"
					+ "player:Oli,gamepad1,red;player:Sebbi,gamepad2,yellow";
			}
			PARAMS = PARAMS.slice(1).split(';');
			if(PARAMS[0] != 'adcfgv:' + CFGVERSION){
				alert("Link contains invalid or outdated game configuration!");
				PARAMS = "#adcfgv:" + CFGVERSION
					+ "debug:0;player:Dani,keyboard,pink;player:Mirko,mouse,lime;"
					+ "player:Oli,gamepad1,red;player:Sebbi,gamepad2,yellow";
			}

			var NUM_PLAYERS = 0;
			
			for(var i=0; i<PARAMS.length; i++){
				var key = PARAMS[i].split(':')[0];
				var value = PARAMS[i].split(':')[1];

				if(key == "player"){NUM_PLAYERS++;} // players are read later
				if(key == "debug"){DEBUG = 1*value;}
				if(key == "map"){MAP = value;}
				if(key == "hp"){HITPOINTS = value * 1;}
				if(key == "shld"){SHIELD = value *1;}
				if(key == "shldreg"){SHIELD_REGEN = value * 1;}
				if(key == "ammo"){PHASER_AMMO = value * 1;}
				if(key == "ammoreg"){PHASER_REGEN = value * 1;}
				if(key == "time"){ROUND_TIME = value * 1;}
				if(key == "bump"){TERRAIN_BUMP_MAPPING = value=="1";}
				if(key == "h2o"){FANCY_WATER = value=="1";}
				if(key == "vol"){MUSIC_VOLUME = 0.01*value;}
			}
		</script>

		<script src="src/jslibs/three.js"></script> <!-- WebGL wrapper, main framework (http://threejs.org) -->
		<!--<script src="src/jslibs/math.min.js"></script>--> <!-- math functions (http://mathjs.org/) (SEEMS BUGGY)-->
		<script src="src/jslibs/OrbitControls.js"></script> <!-- camera orbit controls, part of three.js -->
		<script src="src/jslibs/p2.js"></script> <!-- p2 physics engine (https://schteppe.github.io/p2.js) -->
		<script src="src/jslibs/stats.min.js"></script> <!-- framerate display -->
		<script src="src/jslibs/DDSLoader.js"></script> <!-- file loader, part of three.js -->
		<script src="src/jslibs/OBJLoader.js"></script> <!-- file loader, part of three.js -->
		<script src="src/jslibs/MTLLoader.js"></script> <!-- file loader, part of three.js -->
		<script src="src/jslibs/distancetf.js"></script> <!-- distance transform for boolean images (extracted from https://parmanoir.com/distance) -->
		<script src="src/jslibs/buffer-loader.js"></script> <!-- loader that was used by the sound tutorial page http://www.html5rocks.com/en/tutorials/webaudio/intro/ -->
		<script src="src/jslibs/GPUComputationRenderer.js"></script> <!-- for water cellular automata https://github.com/mrdoob/three.js/blob/dev/examples/js/GPUComputationRenderer.js -->
		<script src="src/jslibs/THREE.MeshLine.js"></script> <!-- for trails https://github.com/spite/THREE.MeshLine -->

		<script src="src/imglib.js"></script>
		<script src="src/Checklist.js"></script>
		<script src="src/mechanics.js"></script>
		<script src="src/scene.js"></script>
		<script src="src/Trail.js"></script>
		
                <script src="src/control/Control.js"></script>
                <script src="src/control/Mouse.js"></script>
                <script src="src/control/Gamepad.js"></script>
                <script src="src/control/Keyboard.js"></script>                
                <script src="src/control/MobileDevice.js"></script>
		
                <script src="src/Sound.js"></script>
		<script src="src/HBObject.js"></script>
		<script src="src/Effect.js"></script>
		<script src="src/explosion.js"></script>
		<script src="src/Flame.js"></script>
		<script src="src/Hovercraft.js"></script>
		<script src="src/Phaser.js"></script>

			<script src="src/arena/ArenaSvgLoader.js"></script>
			<script src="src/arena/Arena.js"></script>

		<script src="src/Water.js"></script>
		<script src="src/camera.js"></script>
		<script src="src/powerups.js"></script>


		<script type="text/javascript">

			var PAUSED = true;

			var hovers=[];
			var ARENA;

			ARENA = new Arena(MAP);

			var startp0, startp1, finishp0, finishp1;

			function start() {
				onWindowResize(); // call to initially adjust camera
				document.getElementById("splashscreen").style.visibility = "hidden";
				RENDERER.setClearColor( FOG_COLOR );

				RESPAWN_TIME = 1e10;
				HITPOINTS = 1e10;

				var startLine = ASL.domsvg.getElementById("startline").getAttribute("d"); // make sure this is "M x1,y1 L x2,y2"
				startLine = startLine.replaceAll(" ", "").replaceAll("M", "").split("L");
				startp0 = new THREE.Vector2().fromArray(startLine[0].split(","));
				startp0.x-=MAP_WIDTH/2; startp0.y=MAP_HEIGHT/2-startp0.y;
				startp1 = new THREE.Vector2().fromArray(startLine[1].split(","));
				startp1.x-=MAP_WIDTH/2; startp1.y=MAP_HEIGHT/2-startp1.y;

				var finishLine = ASL.domsvg.getElementById("finishline").getAttribute("d"); // make sure this is "M x1,y1 L x2,y2"
				finishLine = finishLine.replaceAll(" ", "").replaceAll("M", "").split("L");
				finishp0 = new THREE.Vector2().fromArray(finishLine[0].split(","));
				finishp0.x-=MAP_WIDTH/2; finishp0.y=MAP_HEIGHT/2-finishp0.y;
				finishp1 = new THREE.Vector2().fromArray(finishLine[1].split(","));
				finishp1.x-=MAP_WIDTH/2; finishp1.y=MAP_HEIGHT/2-finishp1.y;

				var iPlayer=0;

				for(var i=0; i<PARAMS.length; i++){
					var key = PARAMS[i].split(':')[0];
					var value = PARAMS[i].split(':')[1];

					if(key=="player"){
						hovers[iPlayer] = new Hovercraft(
								new THREE.Color(value.split(',')[1]),
								Control.createControl(value));
						hovers[iPlayer].playerName = value.split(',')[0];						
						var startPos = startp0.clone().lerp(startp1,(iPlayer+1)/(NUM_PLAYERS+1));
						hovers[iPlayer].initNewRound(startPos);
						hovers[iPlayer].control.direction = hovers[iPlayer].body.angle = Math.atan2(startp1.y-startp0.y, startp1.x-startp0.x)+Math.PI/2;

						hovers[iPlayer].lastPosition = new THREE.Vector2;
						hovers[iPlayer].newPosition = new THREE.Vector2;
						hovers[iPlayer].racetime = 0;

						iPlayer++;
					}
				}
				Hovercraft.prototype.wallhit = function(){ // penalty
					this.body.velocity[0] *= 0.2;
					this.body.velocity[1] *= 0.2;
					effect = new Effect();
					effect.type = 'star';
					effect.mesh = STAR_MESH.clone();
					effect.mesh.position.x = this.body.position[0];
					effect.mesh.position.y = this.body.position[1];
					effect.mesh.position.z = 0.2;
					effect.mesh.renderOrder = STAR_MESH.renderOrder; // TODO: maybe remove if fixed in three.js
					effect.mesh.material = STAR_MESH.material.clone();
					effect.mesh.material.color.copy(this.color);
					effect.mesh.scale.set(2,2,1);
					effect.spawn();
					effect.strength = 5;
					effect.decay = 80;
					effect.growth = 30;
				} 
				
				PAUSED = false;
				//ingameTimeout(ROUND_TIME, function(){endRound();});				
				animate();
			}
			LOADING_LIST.setCallback(start);

			function animate() {
				//setTimeout(function(){ requestAnimationFrame( animate ); }, 100);
				
				if(PAUSED){return;}

				requestAnimationFrame( animate );

				updateIngameTimeouts();

				//maybeSpawnPowerup();

				for(var i=0; i<hovers.length; i++){
					hovers[i].lastPosition.fromArray(hovers[i].body.position);
					if(INGAME_TIME<2){hovers[i].body.velocity[0] = hovers[i].body.velocity[1] = 0;} // start delay
				}

				PHYSICS_WORLD.step(DT);

				var allFinished = true;

				for(var i=0; i<hovers.length; i++){
					hovers[i].newPosition.fromArray(hovers[i].body.position);

					if(!hovers[i].hidden){
						hovers[i].racetime += DT;
						allFinished = false;
					}

					var finish = linesegintersect(hovers[i].lastPosition, hovers[i].newPosition, finishp0, finishp1);

					if(finish.bool){ // crossed the finish line
						hovers[i].hitpoints = 0;
						hovers[i].racetime += -2 -DT + finish.s*DT; // subframe accuracy for time measurement! (-2 for start delay)
					};
				}

				if(allFinished){ingameTimeout(1, function(){endRound();})};	

				updateAllHBObjects();
				updateAllEffects();

				updateWater();
				updateCam();

				RENDERER.render( GRAPHICS_SCENE, CAMERA );
				if(DEBUG>=1){STATS.update()};

				FRAME_COUNTER++;
				INGAME_TIME += DT;

				/*if(FRAME_COUNTER% 6  == 5){
					explosion(new THREE.Vector3(Math.random()*40-20, Math.random()*30-15, 0), new THREE.Color(Math.floor(Math.random()*0x1000000)));
				}*/
				
			}

			function pad(num, size){var s = num+""; while (s.length < size) s = "0" + s; return s;} // 0 padding for time
			function endRound(){

				PAUSED = true;

				var html = "<center><table width=60% style='font-weight:bold'>"
					+ "<tr><td>Player</td><td>Time</td></tr>";
				//hovers.sort(function(a, b){return (b.kills*1.001-b.deaths) - (a.kills*1.001-a.deaths);});
				hovers.sort(function(a, b){return (a.racetime - b.racetime);});
				// not sure if it is a good idea to shuffle this array, lets see

				for(var i=0; i<hovers.length; i++){
					var h = 0.3*hovers[i].color.r + 0.6*hovers[i].color.g + 0.1*hovers[i].color.b;
					var shadow = "";
					if(h>0.5){shadow = " text-shadow: -1px -1px black, -1px 1px black, 1px -1px black, 1px 1px black; ";}

					html += "<tr style='color:#" + hovers[i].color.getHexString() + "; "
						+ shadow + "'><td>" + hovers[i].playerName + "</td>";
					html += "<td>" + Math.floor(hovers[i].racetime/60) + ":"
						+ pad(Math.floor(hovers[i].racetime%60),2) + "."
						+ pad(Math.round(1000*(hovers[i].racetime%1)),3) + "</td></tr>";				
				}
				html += "</table></center>";

				document.getElementById("splashscreentext").style.fontSize = "12pt";
				document.getElementById("splashscreentext").innerHTML = html;
				document.getElementById("splashscreen").style.visibility = "visible";
				
				setTimeout(function(){newRound();}, PAUSE_TIME*1000);
			}

			function newRound(){
				INGAME_TIME = 0;

				for(var i=0; i<hovers.length; i++){
					var startPos = startp0.clone().lerp(startp1,(i+1)/(NUM_PLAYERS+1));
					hovers[i].initNewRound(startPos);
					hovers[i].control.direction = hovers[i].body.angle = Math.atan2(startp1.y-startp0.y, startp1.x-startp0.x)+Math.PI/2;
					hovers[i].body.velocity[0] = hovers[i].body.velocity[1] = 0;
					hovers[i].racetime = 0;
					hovers[i].update();
				}

				for(var i=0; i<EFFECT_LIST.length; i++){
					EFFECT_LIST[i].despawn();
				}
				updateAllEffects();

				for(var i=0; i<HBO_LIST.length; i++){
					if(HBO_LIST[i].type != 'hover'){
						HBO_LIST[i].despawn();
					}
				}
				NPUBOXES = 0;
				GLOBAL_POWERUP_TARGET.pu = POWERUPS.nothing;
				GLOBAL_POWERUP_TARGET.victim = [];
				DT = DT_ORIGINAL;

				updateAllHBObjects();				

				TIMEOUT_LIST = [];
				document.getElementById("splashscreen").style.visibility = "hidden";
				PAUSED = false;
				ingameTimeout(ROUND_TIME, function(){endRound();});
				animate();		

			}

		</script>
	</body>
</html>
