<html>
<head>

<script src="https://www.airconsole.com/api/airconsole-1.7.0.js"></script>
<script src="src/utils/tools.js"></script>
<script src="src/jslibs/rate-limiter.js"></script>
<script src="src/controller/touch.js"></script>
<script src="src/controller/graphics.js"></script>

<style>
* {
	margin: 0;
	padding: 0;
	touch-action: none;
	font-size:20pt;
	font-family:sans-serif;
	color:white;
}
div{
	position:absolute;
	display:inline-block;
	/*background-color:yellow;*/
}
svg{
	pointer-events:none;
}
body{
	overflow:hidden;
	background-color:black;
}
</style>
</head>

<body onLoad="init()">

<div id="svgdefs"></div>

<div class="tab" id="menu">
	<div id="left" class="touchable" data-downcallback="left" style="background-color:green">&lt;&lt;</div>
	<div id="go" class="touchable" data-downcallback="go" style="background-color:green">GO!</div>
	<div id="right" class="touchable" data-downcallback="right" style="background-color:green">&gt;&gt;</div>
</div>

<div class="tab" id="game">

	<!-- joystick -->
	<div class="controller" id="joystickcontroller">
		<div id="joyarea" class="touchable" data-movecallback="moveStick" data-upcallback="releaseStick">
			<div id="joystick" style="pointer-events:none"></div>
		</div>
		<div id="joytrigger" class="touchable" data-downcallback="startFiring" data-upcallback="stopFiring"></div>
	</div>

	<!-- thrust lever -->
	<div class="controller" id="levercontroller">
		<div id="leverarea" class="touchable" data-movecallback="moveLever" data-upcallback="releaseLever">
			<div id="lever" style="pointer-events:none"></div>
		</div>
		<div id="levertrigger" class="touchable" data-downcallback="startFiring" data-upcallback="stopFiring"></div>
	</div>

	<!-- yoke -->
	<div class="controller" id="yokecontroller">
		<div id="yoketriggerarea" class="touchable" data-downcallback="startFiring" data-upcallback="stopFiring"></div>
		<div id="yoketriggericon1" style="pointer-events:none"></div>
		<div id="yoketriggericon2" style="pointer-events:none"></div>
	</div>

	<div id="status"></div>
	<div id="changecontroller" class="touchable" data-downcallback="changeController">Change Controller</div>
</div>

<div id="log" style="left:0px; top:0px; width:100%; height:100%; font-size:24px; pointer-events:none; word-wrap:break-word; display:none"></div>

<div style="right:0px; bottom:0px; width:5%; height:10%; font-size:24px; color:#aaa" onclick="toggleLog()">Log</div>

<script>

var airConsole
var rateLimiter

var dimensions = {}
var activeController = 0

var lastDirection = undefined
var lastSpin = undefined
var lastThrust = undefined
var lastFire = undefined
var lastState = undefined

var currentDirection = Math.random()*2*Math.PI - Math.PI
var currentSpin = 0
var currentThrust = 0
var currentFire = 0
var currentState = "menu"

dimensions.w = 800
dimensions.h = 600

function log(txt){
	var history = document.getElementById("log").innerHTML
	var display = txt + "<br>" + history
	display = display.substr(0, 4000)
	document.getElementById("log").innerHTML = display
}

function toggleLog(){
	var logwindow = document.getElementById("log")
	if(logwindow.style.display == "none"){
		logwindow.style.display = "inline-block"
	}
	else{
		logwindow.style.display = "none"
	}
}

Touch.init()

function init(){
	airConsole = new AirConsole({orientation: "landscape", device_motion:30})
	rateLimiter = new RateLimiter(airConsole);

	airConsole.onCustomDeviceStateChange = function(device_id, custom_data){
		log(JSON.stringify(custom_data))

		if(AirConsole.SCREEN == device_id){
			if(custom_data == undefined){
				currentState = "menu"
			}
			else{
				currentState = custom_data.state
			}

			var tabs = document.getElementsByClassName("tab")
			for(var i=0; i<tabs.length; i++){
				tabs[i].style.display = "none"
			}
			if(currentState == "menu"){
				document.getElementById("menu").style.display = "inline-block"
			}
			if(currentState == "game"){
				document.getElementById("game").style.display = "inline-block"
			}
		}
	}
	airConsole.onCustomDeviceStateChange(AirConsole.SCREEN, airConsole.getCustomDeviceState(AirConsole.SCREEN))

	airConsole.onDeviceMotion = function (data){
		if(currentState == "game" && document.getElementById("yokecontroller").style.display != "none"){
			var x = data.beta/40.0
			var y = (data.gamma+45.0)/40.0

			var dir = Math.atan2(y, x)
			var r = Math.sqrt(x*x + y*y)

			if(r < 0.01){
				x = 0
				y = 0
				r = 0
				dir = undefined
			}
			if(r > 1.0){
				x = x/r
				y = y/r
				r = 1.0
			}
			currentDirection = dir
			currentSpin = undefined
			currentThrust = r

			sendControls()
		}
	}

	window.onresize()

	Graphics.init()
}

function message(msg){
	log(JSON.stringify(msg))
	rateLimiter.message(AirConsole.SCREEN, msg)
}

function sendControls(){
	if(currentState == "game"){
		if(
			lastDirection != currentDirection ||
			lastSpin != currentSpin ||
			lastThrust != currentThrust ||
			lastFire != currentFire ||
			lastState != currentState
		){
			var data = {type:"control", thrust:currentThrust, fire:currentFire}
			if(currentDirection != undefined){
				data.direction = currentDirection
			}
			if(currentSpin != undefined){
				data.spin = currentSpin
			}
			message(data)

			lastDirection = currentDirection
			lastSpin = currentSpin
			lastThrust = currentThrust
			lastFire = currentFire
		}
	}

	lastState = currentState
}

Touch.callbacks.left = function(){
	message({type:"menu", navi:"left"})
}

Touch.callbacks.right = function(){
	message({type:"menu", navi:"right"})
}

Touch.callbacks.go = function(){
	message({type:"menu", navi:"go"})
}

Touch.callbacks.startFiring = function(){
	currentFire = 1
	sendControls()
}

Touch.callbacks.stopFiring = function(){
	currentFire = 0
	sendControls()
}

Touch.callbacks.moveStick = function(mx, my){
	var x = mx-dimensions.joyHomeX
	var y = my-dimensions.joyHomeY

	var dir = Math.atan2(-y, x)
	var r = Math.sqrt(x*x + y*y)/dimensions.joyRange

	if(r < 0.01){
		x = 0
		y = 0
		r = 0
		dir = undefined
	}
	if(r > 1.0){
		x = x/r
		y = y/r
		r = 1.0
	}

	currentDirection = dir
	currentSpin = undefined
	currentThrust = r
	sendControls()
	reposition("joystick", x + dimensions.joyRange, y + dimensions.joyRange)
}

Touch.callbacks.releaseStick = function(){
	currentThrust = 0
	sendControls()
	reposition("joystick", dimensions.joyRange, dimensions.joyRange)
}

Touch.callbacks.moveLever = function(mx, my){
	var x = mx-dimensions.joyHomeX
	var y = my-dimensions.joyHomeY

	if(x > dimensions.joyRange){x = dimensions.joyRange}
	if(x < -dimensions.joyRange){x = -dimensions.joyRange}
	if(y > dimensions.joyRange){y = dimensions.joyRange}
	if(y < -dimensions.joyRange){y = -dimensions.joyRange}

	currentDirection = undefined
	currentSpin = x/dimensions.joyRange
	currentThrust = (-y/dimensions.joyRange + 1.0)/2.0
	sendControls()
	reposition("lever", x + dimensions.joyRange, y + dimensions.joyRange)
}

Touch.callbacks.releaseLever = function(){
	currentDirection = undefined
	currentSpin = 0
	currentThrust = 0
	sendControls()
	reposition("lever", dimensions.joyRange, dimensions.joyRange*2.0)
}

Touch.callbacks.changeController = function(){
	var controllers = document.getElementsByClassName("controller")
	activeController = (activeController + 1) % controllers.length
	for(var i=0; i<controllers.length; i++){
		controllers[i].style.display = "none"
	}
	controllers[activeController].style.display = "inline-block"
}
activeController = -1
Touch.callbacks.changeController()


window.onresize = function(){
	dimensions.w = window.innerWidth
	dimensions.h = window.innerHeight

	dimensions.tile = Math.min(dimensions.w/3.0, dimensions.h)
	dimensions.joyHomeX = dimensions.tile*0.5
	dimensions.joyHomeY = dimensions.h*0.5
	dimensions.joyDiam = dimensions.tile*0.4
	dimensions.joyRange = (dimensions.tile - dimensions.joyDiam)*0.5
	dimensions.triggerDiam = dimensions.tile*0.8

	reposition("status",
			(dimensions.w-dimensions.tile*0.7)*0.5,
			(dimensions.h-dimensions.tile*0.7)*0.4,
			dimensions.tile*0.7,
			dimensions.tile*0.7)

	reposition("joyarea",
			dimensions.joyHomeX - dimensions.joyRange-dimensions.joyDiam*0.5,
			dimensions.joyHomeY - dimensions.joyRange-dimensions.joyDiam*0.5,
			dimensions.tile,
			dimensions.tile)
	reposition("joystick",
			dimensions.joyRange,
			dimensions.joyRange,
			dimensions.joyDiam,
			dimensions.joyDiam)
	reposition("joytrigger",
			dimensions.w-dimensions.tile,
			(dimensions.h-dimensions.tile)*0.5,
			dimensions.tile,
			dimensions.tile)

	reposition("leverarea",
			dimensions.joyHomeX - dimensions.joyRange-dimensions.joyDiam*0.5,
			dimensions.joyHomeY - dimensions.joyRange-dimensions.joyDiam*0.5,
			dimensions.tile,
			dimensions.tile)
	reposition("lever",
			dimensions.joyRange,
			dimensions.joyRange*2.0,
			dimensions.joyDiam,
			dimensions.joyDiam)
	reposition("levertrigger",
			dimensions.w-dimensions.tile,
			(dimensions.h-dimensions.tile)*0.5,
			dimensions.tile,
			dimensions.tile)

	reposition("yoketriggericon1",
			0,
			(dimensions.h-dimensions.tile)*0.5,
			dimensions.tile,
			dimensions.tile)
	reposition("yoketriggericon2",
			dimensions.w-dimensions.tile,
			(dimensions.h-dimensions.tile)*0.5,
			dimensions.tile,
			dimensions.tile)
	reposition("yoketriggerarea",
			0,
			0,
			dimensions.w,
			dimensions.h)

	reposition("changecontroller",
			dimensions.w*0.4,
			dimensions.h - dimensions.w*0.06,
			dimensions.w*0.2,
			dimensions.w*0.06)


	reposition("left",
			0,
			0,
			dimensions.tile*0.9,
			dimensions.h*0.75)

	reposition("go",
			(dimensions.w-dimensions.tile*0.9)*0.5,
			0,
			dimensions.tile*0.9,
			dimensions.h*0.75)

	reposition("right",
			dimensions.w-dimensions.tile*0.9,
			0,
			dimensions.tile*0.9,
			dimensions.h*0.75)

}

</script>

</body>
</html>
